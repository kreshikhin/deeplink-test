<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <title>Deeplink Test</title>
    </head>
    <body>
        <h1>Deeplink Test</h1>
        <p>fingerprint (visitor id):</p>
        <p id="visitor-id"></p>
        <p>device</p>
        <p id="device"></p>
        <p>next url</p>
        <p id="next-url">url</p>
        <button id="button">NEXT >></button>
        <p id="status" style="color: rgb(107, 7, 7);"></p>
        <script id="script">
            GOOGLE_PLAY_URL = 'https://play.google.com/store/apps/details?id=ru.berizaryad';
            APPSTORE_URL = "itms-apps://itunes.apple.com/app/apple-store/id1458730835";
            IOS_CUSTOM_SCHEME_URL ="berizaryad:/"

            window.addEventListener('DOMContentLoaded', function() {
                console.log('onload');
                // Initialize the agent at application startup.
                // If you're using an ad blocker or Brave/Firefox, this import will not work.
                // Please use the NPM package instead: https://t.ly/ORyXk
                import('https://openfpcdn.io/fingerprintjs/v4')
                .then(FingerprintJS => {
                    const fpPromise = FingerprintJS.load()

                    // Get the visitor identifier when you need it.
                    fpPromise
                    .then(fp => fp.get())
                    .then(result => {
                        // The `languages` and `audio` components will be excluded
                        const { screenFrame, screenResolution, vendorFlavors, canvas, ...components } = result.components

                        // Optionally, you can make a visitor identifier from your custom list of components
                        const visitorId = FingerprintJS.hashComponents(components)

                        // // This is the visitor identifier:
                        // const visitorId = result.visitorId
                        console.log(visitorId)
                        document.getElementById('visitor-id').textContent = visitorId;
                    });
                });

                document.getElementById('button').onclick = function(event) {
                    if (getNextURL() === undefined) {
                        alert('undefined url')
                    } else if (getMobileOperatingSystem() == 'iOS') {
                        goto(IOS_CUSTOM_SCHEME_URL, getNextURL());
                    } else {
                        document.location = getNextURL()
                    }
                };

                document.getElementById('device').textContent = getMobileOperatingSystem()
                document.getElementById('next-url').textContent = getNextURL()
            })

            function getNextURL() {
                let os = getMobileOperatingSystem()
                switch(os) {
                case "Android": return GOOGLE_PLAY_URL;
                case "iOS": return APPSTORE_URL;
                }
            }

            function getMobileOperatingSystem() {
                var userAgent = navigator.userAgent || navigator.vendor || window.opera;

                // Windows Phone must come first because its UA also contains "Android"
                if (/windows phone/i.test(userAgent)) {
                    return "Windows Phone";
                }

                if (/android/i.test(userAgent)) {
                    return "Android";
                }

                // iOS detection from: http://stackoverflow.com/a/9039885/177710
                if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    return "iOS";
                }

                if (/macOS/.test(userAgent) && !window.MSStream) {
                    return "macOS";
                }

                //return "unknown - " + userAgent;
                return 'iOS';
            }

            function goto(url, fallback) {
                let timeoutId = setTimeout(function appNotInstalled() {
                    document.location = fallback;
                }, 300);

                document.location = url;
                
                window.addEventListener("blur", function() {
                    console.log('lost focus');
                    clearTimeout(timeoutId);
                });

                window.addEventListener("focus", function() {
                    console.log('take focus');
                    document.location = fallback;
                });
            }

            window.onerror = function(message, url, line, col, errorObj) {
                document.getElementById('status').textContent = `${message}\n${url}, ${line}:${col}`;
            };
        </script>
    </body>
</html>